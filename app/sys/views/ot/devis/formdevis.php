<div class="row">
    <div class="col-md-12">
        <button id="download_devis" class='btn btn-primary btn-sm'><span class='glyphicon glyphicon-download'>&nbsp;</span> Télécharger devis</button>
    </div>
</div>
<br>
<form class="form-horizontal push-10-t push-10" id="devis_detail_form" name="devis_detail_form">
<div class="row items-push">
    <div class="col-md-12">
        <button id="id_devis_edit_btn" class="btn btn-info btn-sm" type="button"><i id="hdf0454ff" class="fa fa-plus push-5-r"></i> Editer devis</button>
    </div>
    <div id="lineare_groupe" style="border-left: dashed 1px #000;border-right: dashed 1px #000;border-bottom: dashed 1px #000;margin-top: 5px;padding: 5px;display: none">

        <div class="form-group col-md-12"> <label><span class="label label-info">Préparation d'un Câble </span></label>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">720FO </span></label>-->
                <label for="ta_lineaire1">RFO_01_01 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_01" name="RFO_01_01" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">432FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_03 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_03" name="RFO_01_03" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">288FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_05 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_05" name="RFO_01_05" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_07 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_07" name="RFO_01_07" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_09 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_09" name="RFO_01_09" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_11 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_11" name="RFO_01_11" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_13 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_13" name="RFO_01_13" value="">
            </div>
        </div>

        <div class="form-group col-md-12"><label><span class="label label-warning">Fenêtre sur câble sur câble </span></label>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">720FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_15 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_15" name="RFO_01_15" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">432FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_16 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_16" name="RFO_01_16" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">288FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_17 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_17" name="RFO_01_17" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_18 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_18" name="RFO_01_18" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_19 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_19" name="RFO_01_19" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_20 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_20" name="RFO_01_20" value="">
            </div>
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">144FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_20 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_20" name="RFO_01_20" value="">
            </div>

        </div>
        <label><span class="label label-primary">Débutable d'un tube en passage pour stockage FO en passage dans une casette </span></label>
        <div class="form-group col-md-12">
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">720FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_21 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_21" name="RFO_01_21" value="">
            </div>

        </div>
        <label><span class="label label-primary">Soudure à l'unité sur câble préparé et intervenant sur place</span></label>
        <div class="form-group col-md-12">
            <div class="col-md-2">
                <!--<label for="ta_lineaire_reseau"><span class="label label-success">720FO </span></label>-->
                <label for="ta_lineaire_reseau">RFO_01_23 <!--<span class="text-danger">*</span>--></label>
                <input class="form-control  lineareInput" type="number" id="RFO_01_23" name="RFO_01_23" value="">
            </div>

        </div>
        <div class="row items-push">
            <div class="form-group">
                <div class="col-xs-12">
                    <button id="btn_update_devis" class="btn btn-primary btn-sm" type="button">Enregistrer</button>
                </div>
            </div>
        </div>
        <br>
        <br>
    </div>
</div>
    </form>
<div class="alert alert-success" id="message_devis_detail" role="alert" style="display: none;"></div>
<div id="devis_uploads">
    <div class="row" style="margin-top: 20px;">
        <div class="col-md-6">
            <label for="devis_bon_cmd_uploader">Bon(s) de commande(s)</label>
            <div id="devis_bon_cmd_uploader"></div>
        </div>
        <div class="col-md-6">
            <label for="devis_autre_uploader">Autre(s) attachement(s)</label>
            <div id="devis_autre_uploader"></div>
        </div>
    </div>
</div>
<script>
    var devis_formdata = {};

    var uploader1_options = {
        url: "api/ot/devis/upload_devis_bon_cmd.php",
        multiple:true,
        dragDrop:true,
        fileName: "myfile",
        autoSubmit: true,
        showDelete:true,
        showDownload:true,
        allowedTypes: "pdf",
        onLoad:function(obj)
        {
            if(id_devis > 0) {
                $.ajax({
                    cache: false,
                    url: "api/ot/devis/load_bon_cmd.php",
                    method:"POST",
                    data: {iddevis:id_devis},
                    dataType: "json",
                    success: function(data)
                    {
                        for(var i=0;i<data.length;i++)
                        {
                            obj.createProgress(data[i]["name"],data[i]["path"],data[i]["size"],data[i]["id"]);
                        }
                    }
                });
            }
        },
        dynamicFormData: function()
        {
            var data ={
                iddevis: id_devis
            };
            return data;
        },
        afterUploadAll:function(obj) {
        },
        downloadCallback:function(data,pd)
        {
            var obj;
            var id;
            try {
                obj = $.parseJSON(data);
                id = obj[0].id;
            } catch (e) {
                var arr = (data + '').split("_");
                id = arr[0];
            }

            location.href="api/file/download.php?id="+id;
        },
        deleteCallback: function (data, pd) {
            var obj;
            var id;
            try {
                obj = $.parseJSON(data);
                id = obj[0].id;
            } catch (e) {
                var arr = (data + '').split("_");
                id = arr[0];
            }

            $.ajax({
                method: "POST",
                url: "api/file/delete.php",
                data: {
                    id: id
                }
            }).done(function (message) {
                console.log(message);
            });

        }
    }
    var uploader2_options = {
        url: "api/ot/devis/upload_devis_autre.php",
        multiple:true,
        dragDrop:true,
        fileName: "myfile",
        autoSubmit: true,
        showDelete:true,
        showDownload:true,
        allowedTypes: "pdf",
        onLoad:function(obj)
        {
            if(id_devis > 0) {
                $.ajax({
                    cache: false,
                    url: "api/ot/devis/load_devis_autre.php",
                    method:"POST",
                    data: {iddevis:id_devis},
                    dataType: "json",
                    success: function(data)
                    {
                        for(var i=0;i<data.length;i++)
                        {
                            obj.createProgress(data[i]["name"],data[i]["path"],data[i]["size"],data[i]["id"]);
                        }
                    }
                });
            }
        },
        dynamicFormData: function()
        {
            var data ={
                iddevis: id_devis
            };
            return data;
        },
        afterUploadAll:function(obj) {
        },
        downloadCallback:function(data,pd)
        {
            var obj;
            var id;
            try {
                obj = $.parseJSON(data);
                id = obj[0].id;
            } catch (e) {
                var arr = (data + '').split("_");
                id = arr[0];
            }

            location.href="api/file/download.php?id="+id;
        },
        deleteCallback: function (data, pd) {
            var obj;
            var id;
            try {
                obj = $.parseJSON(data);
                id = obj[0].id;
            } catch (e) {
                var arr = (data + '').split("_");
                id = arr[0];
            }

            $.ajax({
                method: "POST",
                url: "api/file/delete.php",
                data: {
                    id: id
                }
            }).done(function (message) {
                console.log(message);
            });

        }
    }
    $(function () {
        // Init page plugins & helpers
        uploader1_options = merge_options(defaultUploaderStrLocalisation,uploader1_options);
        uploader1 = $("#devis_bon_cmd_uploader").uploadFile(uploader1_options);

        uploader2_options = merge_options(defaultUploaderStrLocalisation,uploader2_options);
        uploader2 = $("#devis_autre_uploader").uploadFile(uploader2_options);
    });
    $(document).ready(function() {


        $("#download_devis").click(function() {
            if(ot_dt.row('.selected').data()!== undefined) {
                location.href="api/file/parserfile.php?id="+id_devis+"&idsp="+ot_dt.row('.selected').data().id_sous_projet+"&idtot="+ot_dt.row('.selected').data().id_type_ordre_travail;
            }
        });

        $("#id_devis_edit_btn").click(function () {


            if ( $( "#lineare_groupe" ).is( ":hidden" ) ) {
                $("#hdf0454ff").removeClass("fa-plus");
                $("#hdf0454ff").addClass("fa-minus");
                $( "#lineare_groupe" ).show( "fast" );

                console.log('get debis info from ajax');
                $.ajax({
                    method : "GET",
                    url :"app/sys/api/ot/devis/get_details_devis.php",
                    data:{
                        iddevis: id_devis
                    },
                    success : function(reponse){
                        var datajson = JSON.parse(reponse);
                        console.log(datajson);
                        $('#RFO_01_01').val(datajson['RFO_01_01']);
                        $('#RFO_01_03').val(datajson['RFO_01_03']);
                        $('#RFO_01_05').val(datajson['RFO_01_05']);
                        $('#RFO_01_07').val(datajson['RFO_01_07']);
                        $('#RFO_01_09').val(datajson['RFO_01_09']);
                        $('#RFO_01_11').val(datajson['RFO_01_11']);
                        $('#RFO_01_13').val(datajson['RFO_01_13']);
                        $('#RFO_01_15').val(datajson['RFO_01_15']);
                        $('#RFO_01_16').val(datajson['RFO_01_16']);
                        $('#RFO_01_17').val(datajson['RFO_01_17']);
                        $('#RFO_01_18').val(datajson['RFO_01_18']);
                        $('#RFO_01_19').val(datajson['RFO_01_19']);
                        $('#RFO_01_20').val(datajson['RFO_01_20']);
                        $('#RFO_01_21').val(datajson['RFO_01_21']);
                        $('#RFO_01_23').val(datajson['RFO_01_23']);


                    }
                });

                $('#btn_update_devis').click(function () {
                    $('#devis_detail_form *').filter('.form-control:enabled:not([readonly])').each(function(){
                        devis_formdata[$( this ).attr('name')] = $( this).val();
                    });
                    for (var key in devis_formdata) {
                        console.log(devis_formdata);
                        devis_formdata[key] = $('#'+key).val();
                    }
                    devis_formdata['iddevis'] = id_devis;
                    $.ajax({
                        method: "POST",
                        url: "api/ot/devis/save_details_devis.php",
                        data: devis_formdata
                    }).done(function (msg) {
                        $("#message_devis_detail").removeClass('block-opt-refresh');
                        App.showMessage(msg, '#message_devis_detail');
                    });
                });
            } else {
                $( "#lineare_groupe" ).slideUp();
                $("#hdf0454ff").removeClass("fa-minus");
                $("#hdf0454ff").addClass("fa-plus");
            }
        });

    } );
</script>